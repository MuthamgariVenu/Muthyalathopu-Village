<!doctype html>
<html lang="te">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî ‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å</title>

<!-- PapaParse for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  /* Theme variables: default = moon/dark. .day toggles light */
  :root{
    --bg: #07102a;
    --card: rgba(255,255,255,0.03);
    --text: #e6f0ff;
    --muted: #b9c7dd;
    --accent: #fb923c;

    --btn-bg: rgba(255,255,255,0.06);
    --btn-text: #e6f0ff;
    --btn-border: rgba(255,255,255,0.06);

    --badge-ok-bg: #dcfce7;
    --badge-ok-text: #065f46;
    --badge-no-bg: #fff1f0;
    --badge-no-text: #7f1d1d;

    --panel-shadow: 0 12px 40px rgba(0,0,0,0.6);
  }

  html.day{
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#6b7280;
    --accent:#f97316;

    --btn-bg:#f3f4f6;
    --btn-text:#0f172a;
    --btn-border:rgba(2,6,23,0.06);

    --badge-ok-bg:#dcfce7;
    --badge-ok-text:#065f46;
    --badge-no-bg:#fff1f0;
    --badge-no-text:#7f1d1d;

    --panel-shadow: 0 12px 40px rgba(2,6,23,0.08);
  }

  html,body{height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); transition:background .18s,color .18s;}
  .container{max-width:1100px;margin:18px auto;padding:12px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:1.2rem}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.2); margin-bottom:12px}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:8px;background:var(--btn-bg);color:var(--btn-text);border:1px solid var(--btn-border);cursor:pointer;font-weight:600}
  .link-btn{padding:8px 12px;border-radius:8px;background:transparent;color:var(--btn-text);border:1px solid transparent;cursor:pointer;font-weight:600}
  .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{background:transparent;color:var(--muted)}
  .link{color:var(--accent);cursor:pointer;text-decoration:underline}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200}
  .modal .backdrop{position:absolute; inset:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(3px);}
  .modal .panel{
    position:relative;
    width:94%;
    max-width:960px;
    box-sizing:border-box;
    max-height:85vh;
    overflow:auto;
    background:var(--card);
    color:var(--text);
    border-radius:12px;
    padding:18px;
    z-index:1201;
    box-shadow: var(--panel-shadow);
  }
  .modal h3{margin:0 0 6px 0}
  .modal hr{border:none;border-top:1px solid rgba(255,255,255,0.04);margin:10px 0}
  .badge{display:inline-block;padding:6px 10px;border-radius:8px;margin-right:8px;margin-top:6px;font-weight:700}
  .badge.ok{ background:var(--badge-ok-bg); color:var(--badge-ok-text); }
  .badge.no{ background:var(--badge-no-bg); color:var(--badge-no-text); }

  @media(max-width:640px){ .container{padding:10px} .modal .panel{padding:12px; max-width:96%} }

  .tiny{font-size:0.92rem}
</style>
</head>
<body id="page">

<div class="container">
  <header>
    <div>
      <h1 class="telugu">‡∞®‡∞ø‡∞∞‡±ç‡∞µ‡∞æ‡∞π‡∞ï‡±Å‡∞≤ ‡∞™‡±á‡∞ú‡±Ä ‚Äî Admin</h1>
      <div class="muted tiny telugu">‡∞ï‡±á‡∞µ‡∞≤‡∞Ç ‡∞Ö‡∞°‡±ç‡∞Æ‡∞ø‡∞®‡±ç ‡∞µ‡±Ä‡∞ï‡±ç‡∞∑‡∞£ ‡∞ï‡±ã‡∞∏‡∞Ç</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <!-- HOME / BACK button (always visible) -->
      <a href="index.html" class="btn" title="Home">üè† ‡∞π‡±ã‡∞Æ‡±ç</a>

      <!-- Theme toggle -->
      <button id="themeToggle" class="btn" title="Toggle Day / Moon">üåô</button>
    </div>
  </header>

  <!-- Login Card -->
  <div id="loginCard" class="card">
    <h3 class="telugu">‡∞Ö‡∞°‡±ç‡∞Æ‡∞ø‡∞®‡±ç ‡∞≤‡∞æ‡∞ó‡∞ø‡∞®‡±ç</h3>
    <div class="muted telugu">‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Ø‡±Ç‡∞ú‡∞∞‡±ç‚Äå‡∞®‡±á‡∞Æ‡±ç & ‡∞™‡∞æ‡∞∏‡±ç‡∞µ‡∞∞‡±ç‡∞°‡±ç ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø</div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
      <input id="username" class="input" placeholder="username" />
      <input id="password" class="input" type="password" placeholder="password" />
      <button id="loginBtn" class="btn telugu">‡∞≤‡±ã‡∞ó‡∞ø‡∞®‡±ç</button>
      <button id="demoBtn" class="btn telugu">‡∞°‡±Ü‡∞Æ‡±ã (‡∞∏‡∞ø‡∞Æ‡±ç)</button>
    </div>
    <div class="muted" style="margin-top:8px">‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï: ‡∞á‡∞¶‡∞ø client-side login. production ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞Ç‡∞°‡±ç ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Ç.</div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminArea" style="display:none;">
    <div class="card">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div>
          <div class="muted telugu">‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ú‡∞®‡∞æ‡∞≠‡∞æ</div>
          <div id="totalPop" style="font-weight:700;font-size:1.3rem">‚Äî</div>
        </div>
        <div>
          <div class="muted telugu">‡∞á‡∞≥‡±ç‡∞≥ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø</div>
          <div id="totalHouses" style="font-weight:700;font-size:1.3rem">‚Äî</div>
        </div>
        <div style="margin-left:auto;">
          <div class="controls">
            <button id="downloadResidents" class="btn telugu">Residents CSV</button>
            <button id="downloadHouseholds" class="btn telugu">Households CSV</button>
            <button id="logoutBtn" class="btn telugu">‡∞≤‡∞æ‡∞ó‡±å‡∞ü‡±ç</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <div>
          <label class="muted telugu">‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞Ç‡∞ó‡∞æ ‡∞ö‡±Ç‡∞™‡∞ø‡∞Ç‡∞ö‡±Å:</label>
          <select id="orderSelect" class="input">
            <option value="order">CSV ‡∞≤‡±ã ‡∞á‡∞ö‡±ç‡∞ö‡∞ø‡∞® order (order column)</option>
            <option value="name">‡∞™‡±á‡∞∞‡±Å (‡∞Ö‡∞ï‡±ç‡∞∑‡∞∞‡∞æ‡∞®‡±Å‡∞ï‡±ç‡∞∞‡∞Æ‡∞Ç)</option>
            <option value="age">‡∞µ‡∞Ø‡∞∏‡±Å (descending)</option>
            <option value="house">House ID</option>
          </select>
        </div>
        <div style="margin-left:auto;">
          <input id="searchBox" class="input" placeholder="‡∞™‡±á‡∞∞‡±Å / ‡∞´‡±ã‡∞®‡±ç ‡∞µ‡±Ü‡∞§‡∞ï‡∞Ç‡∞°‡∞ø" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <table id="resTable">
          <thead><tr><th class="telugu">ID</th><th class="telugu">‡∞™‡±á‡∞∞‡±Å</th><th class="telugu">House</th><th class="telugu">Age</th><th class="telugu">Phone</th><th class="telugu">Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="backdrop" onclick="safeCloseModal()"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div>
        <h3 id="modalTitle" class="telugu"></h3>
        <div id="modalSubtitle" class="muted"></div>
      </div>
      <div>
        <button id="closeModalBtn" class="btn telugu">‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø</button>
      </div>
    </div>

    <hr />

    <div style="display:flex;gap:18px;flex-wrap:wrap;">
      <div style="flex:1;min-width:240px">
        <div class="muted telugu">‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å</div>
        <div id="modalDetails" style="margin-top:8px"></div>
        <div style="margin-top:12px;">
          <div class="muted telugu">‡∞°‡∞æ‡∞ï‡±ç‡∞Ø‡±Å‡∞Æ‡±Ü‡∞Ç‡∞ü‡±ç‡∞≤‡±Å</div>
          <div id="docStatus" style="margin-top:6px"></div>
        </div>
      </div>

      <div style="flex:1;min-width:240px">
        <div class="muted telugu">‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å</div>
        <div id="modalSchemes" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* HOME URL - change if your home file name is different */
const HOME_URL = 'index.html';

/* demo credentials */
const CREDENTIALS = { user:'admin', pass:'admin123' };

/* DOM refs */
const themeToggle = document.getElementById('themeToggle');
const loginCard = document.getElementById('loginCard');
const adminArea = document.getElementById('adminArea');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const logoutBtn = document.getElementById('logoutBtn');

const totalPop = document.getElementById('totalPop');
const totalHouses = document.getElementById('totalHouses');
const resTableBody = document.querySelector('#resTable tbody');
const searchBox = document.getElementById('searchBox');
const orderSelect = document.getElementById('orderSelect');

const modal = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModalBtn');
const modalTitle = document.getElementById('modalTitle');
const modalSubtitle = document.getElementById('modalSubtitle');
const modalDetails = document.getElementById('modalDetails');
const docStatus = document.getElementById('docStatus');
const modalSchemes = document.getElementById('modalSchemes');

const downloadResidents = document.getElementById('downloadResidents');
const downloadHouseholds = document.getElementById('downloadHouseholds');

let residents = [], households = [], beneficiaries = [];

/* THEME */
function applySavedTheme(){
  const v = localStorage.getItem('muthya_theme') || 'moon';
  if(v === 'day') document.documentElement.classList.add('day');
  else document.documentElement.classList.remove('day');
  updateThemeButton();
}
function toggleTheme(){
  const isDay = document.documentElement.classList.toggle('day');
  localStorage.setItem('muthya_theme', isDay ? 'day' : 'moon');
  updateThemeButton();
}
function updateThemeButton(){
  const isDay = document.documentElement.classList.contains('day');
  themeToggle.textContent = isDay ? 'üåû' : 'üåô';
}
applySavedTheme();
themeToggle.addEventListener('click', toggleTheme);

/* CSV loader util (PapaParse) */
function loadCSV(path){
  return new Promise((res, rej)=>{
    Papa.parse(path, { download:true, header:true, skipEmptyLines:true, complete:(r)=>res(r.data), error:(e)=>rej(e) });
  });
}

/* login/logout */
function setLoggedIn(state){
  if(state){ loginCard.style.display='none'; adminArea.style.display='block'; }
  else { loginCard.style.display='block'; adminArea.style.display='none'; }
}
loginBtn.addEventListener('click', ()=>{
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(u===CREDENTIALS.user && p===CREDENTIALS.pass){
    localStorage.setItem('muthya_admin','1');
    setLoggedIn(true);
    initAdminData();
  } else alert('Invalid credentials (demo: admin / admin123)');
});
demoBtn.addEventListener('click', ()=> { localStorage.setItem('muthya_admin','1'); setLoggedIn(true); initAdminData(); });

/* LOGOUT: clear session and redirect to HOME */
logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem('muthya_admin');
  setLoggedIn(false);
  // redirect user back to home (acts as back button)
  window.location.href = HOME_URL;
});

/* modal open/close */
function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; }
function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }
function safeCloseModal(){ closeModal(); }
closeModalBtn.addEventListener('click', closeModal);

/* escape */
function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Render residents */
function renderResidents(){
  const q = (searchBox.value||'').toLowerCase().trim();
  let list = [...residents];
  const order = orderSelect.value;
  if(order === 'order'){
    if(list.every(r => r.order !== undefined && r.order !== '')) {
      list.sort((a,b)=> Number(a.order||0) - Number(b.order||0));
    }
  } else if(order === 'name'){
    list.sort((a,b)=> (a.name_tel||a.name||'').localeCompare(b.name_tel||b.name||''));
  } else if(order === 'age'){
    list.sort((a,b)=> Number(b.age||0) - Number(a.age||0));
  } else if(order === 'house'){
    list.sort((a,b)=> (a.house_id||'').localeCompare(b.house_id||''));
  }
  if(q) list = list.filter(r => (r.name_tel||r.name||'').toLowerCase().includes(q) || (r.phone||'').toLowerCase().includes(q) || (r.house_id||'').toLowerCase().includes(q));
  resTableBody.innerHTML = '';
  list.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(r.id||'')}</td>
      <td><span class="link">${esc(r.name_tel||r.name||'‚Äî')}</span></td>
      <td>${esc(r.house_id||'‚Äî')}</td>
      <td>${esc(r.age||'‚Äî')}</td>
      <td>${esc(r.phone||'‚Äî')}</td>
      <td><button class="btn" data-id="${esc(r.id||'')}" onclick="viewResident('${esc(r.id||'')}')">View</button></td>`;
    tr.querySelector('.link').addEventListener('click', ()=> viewResident(r.id));
    resTableBody.appendChild(tr);
  });
}

/* view resident */
window.viewResident = function(id){
  const r = residents.find(x=> (x.id||'')===(id||''));
  if(!r){ alert('Record not found'); return; }
  modalTitle.textContent = r.name_tel || r.name || '';
  modalSubtitle.textContent = `ID: ${r.id || ''}  ‚Ä¢  House: ${r.house_id || ''}`;
  modalDetails.innerHTML = `
    <div><strong class="telugu">‡∞™‡±á‡∞∞‡±Å:</strong> ${esc(r.name_tel||r.name||'')}</div>
    <div><strong class="telugu">‡∞µ‡∞Ø‡∞∏‡±Å:</strong> ${esc(r.age||'‚Äî')}</div>
    <div><strong class="telugu">‡∞≤‡∞ø‡∞Ç‡∞ó‡∞Ç:</strong> ${esc(r.gender||'‚Äî')}</div>
    <div><strong class="telugu">‡∞´‡±ã‡∞®‡±ç:</strong> <a class="link" href="tel:${r.phone||''}">${esc(r.phone||'‚Äî')}</a></div>
    <div><strong class="telugu">‡∞π‡±å‡∞∏‡±ç ‡∞π‡±Ü‡∞°‡±ç:</strong> ${ (r.head_of_house && (r.head_of_house.toLowerCase()==='yes' || r.head_of_house.toLowerCase()==='true')) ? 'Yes' : 'No' }</div>
  `;
  // docs
  const docs = [
    {k:'aadhar_status', label:'Aadhar'},
    {k:'ration_status', label:'Ration Card'},
    {k:'pan_status', label:'PAN'},
    {k:'voter_status', label:'Voter ID'}
  ];
  docStatus.innerHTML = '';
  docs.forEach(d=>{
    const v = (r[d.k]||'').toString().toLowerCase();
    const ok = (v==='yes' || v==='present' || v==='available' || v==='1');
    const span = document.createElement('span');
    span.className = 'badge ' + (ok ? 'ok' : 'no');
    span.textContent = `${d.label}: ${ ok ? 'Yes' : 'No' }`;
    docStatus.appendChild(span);
  });
  // schemes
  const resSchemes = beneficiaries.filter(b => (b.resident_id || b.resident || '') == (r.id || r.name || ''));
  if(!resSchemes.length){
    modalSchemes.innerHTML = '<div class="muted telugu">‡∞à ‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞ø‡∞ï‡∞ø ‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å ‡∞ï‡∞®‡∞¨‡∞°‡∞≤‡±á‡∞¶‡±Å.</div>';
  } else {
    modalSchemes.innerHTML = resSchemes.map(b=>{
      return `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;">
        <div><strong>${esc(b.scheme_code||b.scheme||'')}</strong> ‚Äî ‚Çπ ${esc(b.amount||'0')}</div>
        <div class="muted tiny">${esc(b.status||'')}  ‚Ä¢  ${esc(b.date||'')}</div>
      </div>`;
    }).join('');
  }
  openModal();
}

/* totals & downloads */
function computeTotals(){
  totalPop.textContent = residents.length;
  const housesCount = (households && households.length) ? households.length : new Set(residents.map(r=> r.house_id)).size;
  totalHouses.textContent = housesCount;
}
function downloadCSV(arr, filename){
  if(!arr || !arr.length){ alert('No data'); return; }
  const keys = Object.keys(arr[0]);
  const csv = [keys.join(',')].concat(arr.map(r => keys.map(k => `"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
downloadResidents.addEventListener('click', ()=> downloadCSV(residents, 'residents_export.csv'));
downloadHouseholds.addEventListener('click', ()=> downloadCSV(households, 'households_export.csv'));
searchBox.addEventListener('input', renderResidents);
orderSelect.addEventListener('change', renderResidents);

/* init admin data */
async function initAdminData(){
  try{
    residents = await loadCSV('Data/residents.csv').catch(()=> []);
    households = await loadCSV('Data/households.csv').catch(()=> []);
    beneficiaries = await loadCSV('Data/scheme_beneficiaries.csv').catch(()=> []);
  }catch(e){ console.warn('CSV load fail', e); }
  if(!residents || residents.length===0){
    residents = [
      { id:'RES-001', name_tel:'‡∞∞‡∞æ‡∞Æ‡∞Ø‡±ç‡∞Ø', name:'Ramayya', house_id:'H-001', age:'68', gender:'Male', phone:'+919812345678', aadhar_status:'yes', ration_status:'yes', pan_status:'no', voter_status:'yes', head_of_house:'yes', order:'1' },
      { id:'RES-002', name_tel:'‡∞∏‡±Ä‡∞§‡∞Æ‡±ç‡∞Æ', name:'Seethamma', house_id:'H-001', age:'62', gender:'Female', phone:'+919887654321', aadhar_status:'yes', ration_status:'no', pan_status:'no', voter_status:'yes', head_of_house:'no', order:'2' },
      { id:'RES-003', name_tel:'‡∞∞‡∞ò‡±Å', name:'Raghu', house_id:'H-002', age:'45', gender:'Male', phone:'+919998877665', aadhar_status:'yes', ration_status:'yes', pan_status:'yes', voter_status:'yes', head_of_house:'yes', order:'3' }
    ];
  }
  if(!households || households.length===0){
    households = [
      { house_id:'H-001', house_head_name:'‡∞∞‡∞æ‡∞Æ‡∞Ø‡±ç‡∞Ø', house_no:'1', members_count:'4' },
      { house_id:'H-002', house_head_name:'‡∞∞‡∞ò‡±Å', house_no:'2', members_count:'5' }
    ];
  }
  if(!beneficiaries || beneficiaries.length===0){
    beneficiaries = [
      { id:'B-001', scheme_code:'OLD_AGE_PENSION', resident_id:'RES-001', name:'‡∞∞‡∞æ‡∞Æ‡∞Ø‡±ç‡∞Ø', status:'paid', amount:'4000', date:'2025-09-01' },
      { id:'B-002', scheme_code:'OLD_AGE_PENSION', resident_id:'RES-002', name:'‡∞∏‡±Ä‡∞§‡∞Æ‡±ç‡∞Æ', status:'pending', amount:'4000', date:'2025-09-01' }
    ];
  }

  computeTotals();
  renderResidents();
}

/* restore login on load */
if(localStorage.getItem('muthya_admin')==='1'){
  setLoggedIn(true); initAdminData();
} else setLoggedIn(false);

/* safeClose for backdrop */
window.safeCloseModal = safeCloseModal;
</script>
</body>
</html>
