<!doctype html>
<html lang="te">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å ‚Äî ‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --bg:#f8fafc; --card:#fff; --muted:#6b7280; --accent:#f97316; --text:#0f172a; }
    .moon{ --bg:#07102a; --card:rgba(255,255,255,0.04); --muted:#cbd5e1; --accent:#fb923c; --text:#e6f0ff; }

    body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); }
    header{ position:fixed; top:0; left:0; right:0; z-index:50; background:var(--card); box-shadow:0 2px 6px rgba(2,6,23,0.06); }
    .hdr{ max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 14px; gap:12px; }
    .logo{ width:44px; height:44px; border-radius:8px; object-fit:cover; }
    main{ max-width:1100px; margin:0 auto; padding:92px 14px 28px; }

    .card{ background:var(--card); border-radius:10px; padding:14px; box-shadow:0 1px 4px rgba(2,6,23,0.04); }
    #map{ width:100%; height:420px; border-radius:8px; overflow:hidden; }

    .btn{ padding:8px 12px; border-radius:8px; background:#f3f4f6; cursor:pointer; }
    .tiny{ font-size:0.9rem; }
    .muted{ color:var(--muted); }
  </style>
</head>
<body id="body">

<header>
  <div class="hdr">
    <div style="display:flex;gap:10px;align-items:center;">
      <a href="index.html" class="btn telugu tiny">‚Üê ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç</a>
      <div>
        <div class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‚Äî ‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å</div>
        <div class="tiny muted telugu">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç & ‡∞∏‡∞∞‡±ç‡∞µ‡±Ä‡∞∏‡±Å‡∞≤‡±Å</div>
      </div>
    </div>
    <div>
      <button id="moonToggle" class="btn" title="‡∞∞‡∞æ‡∞§‡±ç‡∞∞‡∞ø/‡∞™‡∞ó‡∞≤‡±Å">üåô</button>
    </div>
  </div>
</header>

<main>
  <div class="card mb-4">
    <h3 class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç (‡∞∏‡∞æ‡∞ü‡∞ø‡∞≤‡±à‡∞ü‡±ç)</h3>
    <div id="map" class="mt-3"></div>
    <div class="muted tiny telugu mt-2">‡∞∏‡∞∞‡∞ø‡∞π‡∞¶‡±ç‡∞¶‡±Å GeoJSON ‡∞â‡∞Ç‡∞ü‡±á ‡∞ö‡±Ç‡∞™‡∞¨‡∞°‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø. ‡∞≤‡±á‡∞ï‡∞™‡±ã‡∞§‡±á ‡∞á‡∞Ç‡∞ü‡∞ø ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡∞∞‡±ç‡∞≤‡±Å CSV ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞µ‡∞∏‡±ç‡∞§‡∞æ‡∞Ø‡∞ø.</div>
  </div>

  <!-- Move Water & Helpline here -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="card">
      <h4 class="font-semibold telugu">‡∞®‡±Ä‡∞∞‡±Å & ‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h4>
      <div id="waterContent" class="muted mt-2 telugu tiny">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø...</div>
    </div>

    <div class="card">
      <h4 class="font-semibold telugu">‡∞Ö‡∞§‡±ç‡∞Ø‡∞æ‡∞µ‡∞∂‡±ç‡∞Ø‡∞ï ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç & ‡∞π‡±Ü‡∞≤‡±ç‡∞™‡±ç‚Äå‡∞≤‡±à‡∞®‡±ç</h4>
      <div id="helplineContent" class="muted mt-2 telugu tiny">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø...</div>
    </div>
  </div>

  <div class="card mb-4">
    <h4 class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç ‚Äî ‡∞Æ‡±å‡∞≤‡∞ø‡∞ï ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h4>
    <div id="basicInfo" class="muted mt-2 telugu tiny">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø...</div>
  </div>
</main>

<script>
/* theme toggle */
const moonToggle = document.getElementById('moonToggle');
function applyMoonFlag(v){ document.documentElement.classList.toggle('moon', v); localStorage.setItem('muthya_moon', v ? '1':'0'); moonToggle.textContent = v ? 'üåû':'üåô'; }
const storedMoon = localStorage.getItem('muthya_moon') === '1';
applyMoonFlag(storedMoon);
moonToggle.addEventListener('click', ()=> applyMoonFlag(!document.documentElement.classList.contains('moon')));

/* Leaflet map */
const center = [14.4371,80.0224];
const map = L.map('map', { zoomControl:true }).setView(center, 16);
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:19, attribution:'Tiles ¬© Esri' }).addTo(map);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' });
L.control.layers({'Satellite':esri,'Road':osm}, null, { position:'topright', collapsed:false }).addTo(map);

/* try load boundary or households */
fetch('Data/mutyalathopu_boundary.geojson').then(r=> r.ok ? r.json() : Promise.reject('no')).then(geo=>{
  L.geoJSON(geo, { style:{ color:'#ff6b00', weight:3, fill:false } }).addTo(map).getBounds && map.fitBounds(L.geoJSON(geo).getBounds().pad(0.15));
}).catch(async ()=>{
  try{
    const txt = await (await fetch('Data/households.csv')).text();
    const rows = Papa.parse(txt, { header:true }).data;
    const markers = [];
    rows.forEach(r=>{
      const lat = parseFloat(r.lat || r.latitude || '');
      const lon = parseFloat(r.lon || r.longitude || '');
      if(!isFinite(lat) || !isFinite(lon)) return;
      const m = L.marker([lat,lon]).addTo(map).bindPopup(`<div style="font-weight:600">${r.name||r.house_id||''}</div><div style="font-size:12px">${r.address||''}</div>`);
      markers.push(m);
    });
    if(markers.length){ map.fitBounds(L.featureGroup(markers).getBounds().pad(0.15)); }
  }catch(e){
    map.setView(center,16);
    L.marker(center).addTo(map).bindPopup('Mutyalathopupalem approximate center').openPopup();
  }
});

/* CSV helper */
function loadCSV(path){
  return fetch(path).then(r=> r.ok ? r.text() : Promise.reject('no')).then(txt=> Papa.parse(txt, { header:true }).data);
}

/* Water & Helpline (moved here) */
const waterKeyMap = { 'water_supply_schedule':'‡∞®‡±Ä‡∞ü‡∞ø ‡∞∏‡∞∞‡∞´‡∞∞‡∞æ ‡∞∑‡±Ü‡∞°‡±ç‡∞Ø‡±Ç‡∞≤‡±ç', 'bore':'‡∞¨‡±ã‡∞∞‡±Å', 'bores':'‡∞¨‡±ã‡∞∞‡±ç‡∞≤‡±Å', 'electricity_line':'‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞≤‡±à‡∞®‡±ç / ‡∞∏‡∞¨‡±ç ‡∞∏‡±ç‡∞ü‡±á‡∞∑‡∞®‡±ç' };
function translateWaterKey(k){ if(!k) return k; k=k.toLowerCase(); for(const key in waterKeyMap){ if(k.includes(key)) return waterKeyMap[key]; } return k.replace(/_/g,' '); }

async function renderWater(){
  const el = document.getElementById('waterContent');
  try{
    const rows = await loadCSV('Data/water_elec.csv');
    if(!rows || !rows.length) throw 'no';
    let html = '';
    rows.forEach(r=>{
      if(r.type && r.detail) html += `<div><strong>${translateWaterKey(r.type)}:</strong> ${r.detail||'‚Äî'}</div>`;
      else for(const k in r){ if(!r[k]) continue; html += `<div><strong>${translateWaterKey(k)}:</strong> ${r[k]}</div>`; }
    });
    el.innerHTML = html;
  }catch(e){ el.innerHTML = '<div class="muted telugu tiny">‡∞®‡±Ä‡∞ü‡∞ø/‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞¶‡±Å.</div>'; }
}

async function renderHelpline(){
  const el = document.getElementById('helplineContent');
  try{
    const rows = await loadCSV('Data/helpline.csv');
    if(!rows || !rows.length) throw 'no';
    let html = '<ul class="list-disc pl-5 telugu tiny">';
    rows.forEach(r=> { const role = r.role_tel || r.role || r.name || ''; const phone = r.phone || r.contact || ''; html += `<li><strong>${role}:</strong> <a class="link" href="tel:${phone}">${phone||'‚Äî'}</a></li>`; });
    html += '</ul>';
    el.innerHTML = html;
  }catch(e){ el.innerHTML = '<div class="muted telugu tiny">‡∞π‡±Ü‡∞≤‡±ç‡∞™‡±ç‚Äå‡∞≤‡±à‡∞®‡±ç ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞¶‡±Å.</div>'; }
}

/* Basic info here too */
async function renderBasic(){
  try{
    const rows = await loadCSV('Data/village_info.csv');
    const r = rows && rows[0] ? rows[0] : {};
    document.getElementById('basicInfo').innerHTML = `<div><strong>‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç:</strong> ${r.village_name_tel || r.village_name_en || '‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å'}</div><div><strong>‡∞Æ‡∞Ç‡∞°‡∞≤‡∞Ç:</strong> ${r.mandal_tel || r.mandal || ''}</div><div><strong>‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ:</strong> ${r.district_tel || r.district || ''}</div>`;
  }catch(e){ document.getElementById('basicInfo').innerHTML = '<div class="muted telugu tiny">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞¶‡±Å.</div>'; }
}

renderWater(); renderHelpline(); renderBasic();

</script>
</body>
</html>
