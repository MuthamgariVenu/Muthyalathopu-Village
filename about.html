<!doctype html>
<html lang="te">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å ‚Äî ‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --bg:#f8fafc; --card:#fff; --muted:#6b7280; --accent:#f97316; --text:#0f172a; }
    .moon{ --bg:#07102a; --card:rgba(255,255,255,0.04); --muted:#cbd5e1; --accent:#fb923c; --text:#e6f0ff; }

    body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); }
    header{ position:fixed; top:0; left:0; right:0; z-index:50; background:var(--card); box-shadow:0 2px 6px rgba(2,6,23,0.06); }
    .hdr{ max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 14px; gap:12px; }
    .logo{ width:44px; height:44px; border-radius:8px; object-fit:cover; }
    main{ max-width:1100px; margin:0 auto; padding:92px 14px 28px; }

    .card{ background:var(--card); border-radius:10px; padding:14px; box-shadow:0 1px 4px rgba(2,6,23,0.04); }
    #map{ width:100%; height:520px; border-radius:8px; overflow:hidden; }

    .btn{ padding:8px 12px; border-radius:8px; background:#f3f4f6; cursor:pointer; }
    .tiny{ font-size:0.9rem; }
  </style>
</head>
<body id="body">

<header>
  <div class="hdr">
    <div style="display:flex;gap:10px;align-items:center;">
      <a href="index.html" class="btn telugu tiny">‚Üê ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç</a>
      <div>
        <div class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‚Äî ‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å</div>
        <div class="tiny muted telugu">‡∞∏‡∞æ‡∞ü‡∞ø‡∞≤‡±à‡∞ü‡±ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç & ‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞™‡±Ü‡∞¶‡±ç‡∞¶‡∞≤‡±Å</div>
      </div>
    </div>
    <div>
      <!-- small moon toggle (desktop) -->
      <button id="moonToggle" class="btn" title="‡∞∞‡∞æ‡∞§‡±ç‡∞∞‡∞ø/‡∞™‡∞ó‡∞≤‡±Å">üåô</button>
    </div>
  </div>
</header>

<main>
  <!-- Map card -->
  <div class="card mb-4">
    <h3 class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç (‡∞∏‡∞æ‡∞ü‡∞ø‡∞≤‡±à‡∞ü‡±ç)</h3>
    <div id="map" class="mt-3"></div>
    <div class="muted tiny telugu mt-2">‡∞∏‡∞∞‡∞ø‡∞π‡∞¶‡±ç‡∞¶‡±Å GeoJSON(‡∞â‡∞®‡±ç‡∞®‡∞ü‡±ç‡∞≤‡∞Ø‡∞ø‡∞§‡±á) ‡∞ö‡±Ç‡∞™‡∞¨‡∞°‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø. ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Ç ‡∞á‡∞Ç‡∞ü‡∞ø ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡∞∞‡±ç‡∞≤‡±Å CSV ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞µ‡∞ö‡±ç‡∞ö‡∞ø ‡∞ï‡∞®‡∞ø‡∞™‡∞ø‡∞∏‡±ç‡∞§‡∞æ‡∞Ø‡∞ø.</div>
  </div>

  <!-- Elders carousel -->
  <div class="card mb-4">
    <h3 class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞™‡±Ü‡∞¶‡±ç‡∞¶‡∞≤‡±Å (‡∞™‡±Ü‡∞¶‡±ç‡∞¶/‡∞Æ‡∞ß‡±ç‡∞Ø/‡∞ö‡∞ø‡∞®‡±ç‡∞®)</h3>
    <div id="eldersCarousel" class="mt-3"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="prevE" class="btn telugu">‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å‡∞ï‡±Å</button>
      <button id="nextE" class="btn telugu">‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§</button>
    </div>
  </div>

  <!-- Basic info below (optional repeat) -->
  <div class="card mb-4">
    <h4 class="font-semibold telugu">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç ‚Äî ‡∞Æ‡±å‡∞≤‡∞ø‡∞ï ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h4>
    <div id="basicInfo" class="muted mt-2 telugu tiny">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø...</div>
  </div>
</main>

<script>
/* theme toggle */
const moonToggle = document.getElementById('moonToggle');
function applyMoonFlag(v){ document.documentElement.classList.toggle('moon', v); localStorage.setItem('muthya_moon', v ? '1':'0'); moonToggle.textContent = v ? 'üåû':'üåô'; }
const storedMoon = localStorage.getItem('muthya_moon') === '1';
applyMoonFlag(storedMoon);
moonToggle.addEventListener('click', ()=> applyMoonFlag(!document.documentElement.classList.contains('moon')));

/* Leaflet map init */
const center = [14.4371,80.0224];
const map = L.map('map', { zoomControl:true }).setView(center, 16);
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:19, attribution:'Tiles ¬© Esri' }).addTo(map);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' });
L.control.layers({'Satellite':esri,'Road':osm}, null, { position:'topright', collapsed:false }).addTo(map);

/* try load GeoJSON boundary */
fetch('Data/mutyalathopu_boundary.geojson').then(r=> r.ok ? r.json() : Promise.reject('no')).then(geo=>{
  const layer = L.geoJSON(geo, { style:{ color:'#ff6b00', weight:3, fill:false } }).addTo(map);
  map.fitBounds(layer.getBounds().pad(0.15));
}).catch(async ()=>{
  // fallback: load households.csv markers if exist
  try{
    const txt = await (await fetch('Data/households.csv')).text();
    const rows = Papa.parse(txt, { header:true }).data;
    const markers = [];
    rows.forEach(r=>{
      const lat = parseFloat(r.lat || r.latitude || '');
      const lon = parseFloat(r.lon || r.longitude || '');
      if(!isFinite(lat) || !isFinite(lon)) return;
      const m = L.marker([lat,lon]).addTo(map).bindPopup(`<div style="font-weight:600">${r.name||r.house_id||''}</div><div style="font-size:12px">${r.address||''}</div><div style="margin-top:6px"><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}">Google ‡∞¶‡∞ø‡∞∂‡∞≤‡±Å</a></div>`);
      markers.push(m);
    });
    if(markers.length){ const g=L.featureGroup(markers); map.fitBounds(g.getBounds().pad(0.15)); }
  }catch(e){
    map.setView(center,16);
    L.marker(center).addTo(map).bindPopup('Mutyalathopupalem approximate center').openPopup();
  }
});

/* elders carousel (use village_peddalu.csv) */
let eidx=0, elders=[];
async function renderElders(){
  try{
    const rows = await fetch('Data/village_peddalu.csv').then(r=> r.ok ? r.text() : Promise.reject('no')).then(t=> Papa.parse(t, { header:true }).data);
    elders = rows || [];
  }catch(e){ elders = []; }

  const wrap = document.getElementById('eldersCarousel');
  if(!elders.length){ wrap.innerHTML = '<div class="muted telugu tiny p-4">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞™‡±Ü‡∞¶‡±ç‡∞¶‡∞≤ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞µ‡±Å.</div>'; return; }

  function show(i){
    eidx = (i + elders.length) % elders.length;
    const it = elders[eidx];
    const role = it.role_tel || it.role || '';
    const name = it.name_tel || it.name || '';
    const note = it.note_tel || it.note || '';
    const photo = it.photo_url || it.photo || 'images/pedda.jpg';
    wrap.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;">
        <div style="width:84px;height:84px;border-radius:9999px;overflow:hidden;background:#f3f4f6;">
          <img src="${photo}" alt="${name}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='images/pedda.jpg'">
        </div>
        <div>
          <div class="font-semibold telugu">${role}</div>
          <div class="text-lg font-bold telugu">${name}</div>
          <div class="muted telugu tiny mt-1">${note}</div>
        </div>
      </div>
    `;
  }
  document.getElementById('prevE').onclick = ()=> { show(eidx-1); resetAuto(); };
  document.getElementById('nextE').onclick = ()=> { show(eidx+1); resetAuto(); };
  show(0);
  function auto(){ window._eldersTimer = setInterval(()=> show(eidx+1), 5000); }
  function resetAuto(){ clearInterval(window._eldersTimer); auto(); }
  auto();
}
renderElders();

/* basic info (also show here) */
async function renderBasic(){
  try{
    const txt = await (await fetch('Data/village_info.csv')).text();
    const rows = Papa.parse(txt, { header:true }).data;
    const r = rows && rows[0] ? rows[0] : {};
    const v_tel = r.village_name_tel || r.village_name_en || '‡∞Æ‡±Å‡∞§‡±ç‡∞Ø‡∞æ‡∞≤‡∞≤‡±ã‡∞™‡±Å';
    const mandal = r.mandal_tel || r.mandal || '';
    const district = r.district_tel || r.district || '';
    document.getElementById('basicInfo').innerHTML = `<div><strong>‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç:</strong> ${v_tel}</div><div><strong>‡∞Æ‡∞Ç‡∞°‡∞≤‡∞Ç:</strong> ${mandal}</div><div><strong>‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ:</strong> ${district}</div>`;
  }catch(e){
    document.getElementById('basicInfo').innerHTML = '<div class="muted telugu tiny">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞≤‡±á‡∞¶‡±Å.</div>';
  }
}
renderBasic();

</script>
</body>
</html>
